<div class="container-fluid p-4">

    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">Finalized Tours</h4>
            <div class="text-muted">Tours ready for booking or currently active</div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-3">Loading tours...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="alert alert-danger">
        {{ error }}
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && !error && tours.length === 0" class="text-center py-5">
        <i class="bi bi-inbox fs-1 text-muted"></i>
        <p class="text-muted mt-3">No finalized tours found</p>
    </div>

    <!-- Main Content: Split View -->
    <div class="row g-4" *ngIf="!loading && !error && tours.length > 0">

        <!-- Left Column: Tour List -->
        <div class="col-md-3">
            <!-- Filters -->
            <!-- Filters -->
            <div class="d-flex gap-2 mb-3 overflow-auto pb-2">
                <button type="button" class="btn btn-sm rounded-pill" [class.btn-dark]="currentFilter === 'All'"
                    [class.btn-outline-dark]="currentFilter !== 'All'" (click)="setFilter('All')">All</button>
                <button type="button" class="btn btn-sm rounded-pill"
                    [class.btn-success]="currentFilter === 'Finalized'"
                    [class.btn-outline-success]="currentFilter !== 'Finalized'"
                    (click)="setFilter('Finalized')">Finalized</button>
                <button type="button" class="btn btn-sm rounded-pill" [class.btn-primary]="currentFilter === 'Ready'"
                    [class.btn-outline-primary]="currentFilter !== 'Ready'" (click)="setFilter('Ready')">Ready</button>
                <button type="button" class="btn btn-sm rounded-pill" [class.btn-warning]="currentFilter === 'Started'"
                    [class.btn-outline-warning]="currentFilter !== 'Started'"
                    (click)="setFilter('Started')">Started</button>
            </div>

            <div class="d-flex flex-column gap-3">
                <div class="card border-0 shadow-sm rounded-4 p-3 cursor-pointer tour-card"
                    *ngFor="let tour of filteredTours" [class.border-primary]="selectedTour?.id === tour.id"
                    [class.bg-light]="selectedTour?.id === tour.id" (click)="selectTour(tour)"
                    style="cursor: pointer; transition: all 0.2s;">
                    <div class="d-flex justify-content-between align-items-start">
                        <h6 class="fw-bold mb-1 text-truncate">{{tour.name}}</h6>
                    </div>
                    <div class="text-muted small mb-2">{{tour.destination}}</div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span *ngIf="tour.status === 'Finalized'"
                            class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">Finalized</span>
                        <span *ngIf="tour.status === 'Ready'"
                            class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill">Ready</span>
                        <span *ngIf="tour.status === 'InProgress'"
                            class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill">Started</span>
                        <span *ngIf="tour.status === 'Completed'"
                            class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill">Completed</span>
                        <small class="fw-bold text-primary">{{tour.pricePerPerson | number}} PKR</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Detail View -->
        <div class="col-md-9">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden" style="min-height: 600px;"
                *ngIf="selectedTour; else noSelection">

                <!-- Tour Header -->
                <div class="card-header bg-white border-bottom p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h4 class="fw-bold mb-1">{{selectedTour.name}}</h4>
                            <div class="text-muted small">
                                <i class="bi bi-geo-alt me-1"></i> {{selectedTour.destination}} &bull;
                                <span class="ms-1">{{selectedTour.duration}}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <h4 class="fw-bold text-primary mb-0">{{selectedTour.pricePerPerson | number}} PKR</h4>
                            <small class="text-muted">per person</small>
                        </div>
                    </div>

                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs card-header-tabs">
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeTab === 'basic'" (click)="setActiveTab('basic')"
                                href="javascript:void(0)">
                                <i class="bi bi-info-circle me-2"></i>Basic Info
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeTab === 'requirements'"
                                (click)="setActiveTab('requirements')" href="javascript:void(0)">
                                <i class="bi bi-list-check me-2"></i>Requirements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeTab === 'offers'" (click)="setActiveTab('offers')"
                                href="javascript:void(0)">
                                <i class="bi bi-check-circle me-2"></i>Accepted Offers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeTab === 'bookings'"
                                (click)="setActiveTab('bookings')" href="javascript:void(0)">
                                <i class="bi bi-people me-2"></i>Booking Details
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Tab Content -->
                <div class="card-body p-4 bg-light">

                    <!-- 1. Basic Information Tab -->
                    <div *ngIf="activeTab === 'basic'" class="fade-in">
                        <div class="row g-4">
                            <div class="col-md-8">
                                <div class="card border-0 shadow-sm rounded-3 h-100">
                                    <div class="card-body p-4">
                                        <h6 class="fw-bold mb-3 text-secondary">Description</h6>
                                        <p class="text-muted">{{selectedTour.description}}</p>

                                        <h6 class="fw-bold mb-3 mt-4 text-secondary">Schedule</h6>
                                        <div class="d-flex gap-5">
                                            <div>
                                                <small class="d-block text-muted">Start Date</small>
                                                <span class="fw-medium">{{selectedTour.startDate |
                                                    date:'mediumDate'}}</span>
                                            </div>
                                            <div>
                                                <small class="d-block text-muted">End Date</small>
                                                <span class="fw-medium">{{selectedTour.endDate |
                                                    date:'mediumDate'}}</span>
                                            </div>
                                            <div>
                                                <small class="d-block text-muted">Duration</small>
                                                <span class="fw-medium">{{selectedTour.duration}}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm rounded-3 mb-3">
                                    <div class="card-body p-4 text-center">
                                        <div class="mb-2">
                                            <i class="bi bi-people fs-1 text-primary"></i>
                                        </div>
                                        <h3 class="fw-bold mb-0">{{selectedTour.totalSeats}}</h3>
                                        <div class="text-muted small">Total Capacity</div>
                                    </div>
                                </div>
                                <div class="card border-0 shadow-sm rounded-3">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center gap-2 mb-2"
                                            *ngIf="selectedTour.status === 'Finalized'">
                                            <i class="bi bi-check-circle-fill text-success"></i>
                                            <span>Tour Finalized</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2 mb-2"
                                            *ngIf="selectedTour.status === 'Ready'">
                                            <i class="bi bi-flag-fill text-primary"></i>
                                            <span>Tour Ready for Departure</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2 mb-3">
                                            <i class="bi bi-check-circle-fill text-success"></i>
                                            <span>Booking Open</span>
                                        </div>

                                        <!-- Actions -->
                                        <button *ngIf="selectedTour.status === 'Finalized'"
                                            class="btn btn-primary w-100 rounded-pill mb-2"
                                            (click)="markTourAsReady(selectedTour.id)">
                                            Mark as Ready
                                        </button>
                                        <button *ngIf="selectedTour.status === 'Ready'"
                                            class="btn btn-outline-primary w-100 rounded-pill mb-2" disabled>
                                            <i class="bi bi-check2-all me-2"></i>Already Ready
                                        </button>

                                        <!-- New Lifecycle Actions -->
                                        <div *ngIf="selectedTour.status === 'Finalized' || selectedTour.status === 'Ready'"
                                            class="mb-2">
                                            <button class="btn btn-success w-100 rounded-pill"
                                                [disabled]="!canStartTour(selectedTour)"
                                                (click)="startTour(selectedTour.id)">
                                                <i class="bi bi-play-fill me-1"></i> Start Tour
                                            </button>
                                            <div *ngIf="!canStartTour(selectedTour)" class="text-center mt-1">
                                                <small class="text-danger" style="font-size: 0.75rem;">
                                                    Starts on {{selectedTour.startDate | date:'mediumDate'}}
                                                </small>
                                            </div>
                                        </div>

                                        <div *ngIf="selectedTour.status === 'InProgress'" class="mb-2">
                                            <!-- Show started status -->
                                            <div class="alert alert-success py-2 px-3 mb-2 small text-center">
                                                <i class="bi bi-activity me-1"></i> Tour in Progress
                                            </div>

                                            <button class="btn btn-danger w-100 rounded-pill"
                                                [disabled]="!canCompleteTour(selectedTour)"
                                                (click)="completeTour(selectedTour.id)">
                                                <i class="bi bi-stop-fill me-1"></i> End Tour
                                            </button>
                                            <div *ngIf="!canCompleteTour(selectedTour)" class="text-center mt-1">
                                                <small class="text-danger" style="font-size: 0.75rem;">
                                                    Ends on {{selectedTour.endDate | date:'mediumDate'}}
                                                </small>
                                            </div>
                                        </div>

                                        <div *ngIf="selectedTour.status === 'Completed'">
                                            <div class="alert alert-secondary py-2 px-3 mb-0 small text-center">
                                                <i class="bi bi-check-circle-fill me-1"></i> Tour Completed
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Requirements Tab -->
                    <div *ngIf="activeTab === 'requirements'" class="fade-in">
                        <div class="row g-3">
                            <div class="col-12" *ngFor="let req of selectedTour.serviceRequirements">
                                <div class="card border-0 shadow-sm rounded-3">
                                    <div class="card-body p-3 d-flex align-items-center gap-3">
                                        <div class="rounded-circle p-3 bg-light">
                                            <i class="bi fs-4" [class.bi-egg-fried]="req.type === 'Meal'"
                                                [class.bi-house]="req.type === 'Accommodation'"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold mb-1">{{req.type}} in {{req.location}}</h6>
                                            <div class="text-muted small">
                                                <i class="bi bi-calendar me-1"></i> {{req.dateNeeded |
                                                date:'mediumDate'}}
                                                <span *ngIf="req.time">&bull; <i class="bi bi-clock me-1"></i>
                                                    {{formatTime(req.time)}}</span>
                                                <span *ngIf="req.stayDurationDays">&bull; <i
                                                        class="bi bi-moon me-1"></i> {{req.stayDurationDays}}
                                                    Nights</span>
                                            </div>
                                            <div class="small text-muted mt-1">Est. People: {{req.estimatedPeople}}
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span
                                                class="badge bg-success-subtle text-success border border-success-subtle">Fulfilled</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Accepted Offers Tab -->
                    <div *ngIf="activeTab === 'offers'" class="fade-in">
                        <h6 class="fw-bold mb-3 text-secondary">Transportation</h6>
                        <div class="card border-0 shadow-sm rounded-3 mb-4"
                            *ngFor="let offer of selectedTour.driverOffers">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="bg-primary-subtle text-primary rounded-circle p-3">
                                            <i class="bi bi-truck fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="fw-bold mb-1">{{offer.driver.user.fullName}}</h6>
                                            <div class="text-muted small">{{offer.vehicle.model}} &bull; Capacity:
                                                {{offer.vehicle.capacity}}</div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold text-primary">{{offer.transportationFare | number}} PKR
                                        </div>
                                        <span class="badge bg-success">Accepted</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3 text-secondary">Restaurants & Accommodation</h6>
                        <div class="row g-3">
                            <div class="col-md-6" *ngFor="let offer of selectedTour.restaurantOffers">
                                <div class="card border-0 shadow-sm rounded-3 h-100">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="fw-bold mb-0">{{offer.restaurant.restaurantName}}</h6>
                                            <span class="badge bg-success">Accepted</span>
                                        </div>
                                        <div class="text-muted small mb-2">{{offer.restaurant.user.fullName}}</div>
                                        <hr class="my-2 opacity-50">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="small text-muted" *ngIf="offer.pricePerPerson">Per Head</span>
                                            <span class="fw-medium" *ngIf="offer.pricePerPerson">{{offer.pricePerPerson
                                                | number}} PKR</span>

                                            <span class="small text-muted" *ngIf="offer.rentPerNight">Per Night</span>
                                            <span class="fw-medium" *ngIf="offer.rentPerNight">{{offer.rentPerNight |
                                                number}} PKR</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Booking Details Tab -->
                    <div *ngIf="activeTab === 'bookings'" class="fade-in">

                        <!-- Progress Card -->
                        <div class="card border-0 shadow-sm rounded-3 mb-4 bg-white">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-end mb-2">
                                    <div>
                                        <h4 class="fw-bold mb-0">{{selectedTour.bookedSeats}} <span
                                                class="text-muted fs-6 fw-normal">/ {{selectedTour.totalSeats}} seats
                                                booked</span></h4>
                                    </div>
                                    <div class="fw-bold text-primary">
                                        {{ (selectedTour.bookedSeats / selectedTour.totalSeats) * 100 | number:'1.0-0'
                                        }}% Full
                                    </div>
                                </div>
                                <div class="progress" style="height: 12px;">
                                    <div class="progress-bar bg-primary" role="progressbar"
                                        [style.width.%]="(selectedTour.bookedSeats / selectedTour.totalSeats) * 100">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bookings List -->
                        <h6 class="fw-bold mb-3 text-secondary">Tourist Bookings ({{selectedTour.bookings.length}})</h6>

                        <div *ngIf="selectedTour.bookings.length === 0"
                            class="text-center py-5 bg-white rounded-3 shadow-sm text-muted">
                            <i class="bi bi-ticket-perforated fs-1 mb-2"></i>
                            <p>No bookings received yet</p>
                        </div>

                        <div class="d-flex flex-column gap-2" *ngIf="selectedTour.bookings.length > 0">
                            <div class="card border-0 shadow-sm rounded-3"
                                *ngFor="let booking of selectedTour.bookings">
                                <div class="card-body p-3 d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="bg-light rounded-circle p-2 text-primary fw-bold border"
                                            style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                            {{booking.touristName?.charAt(0) || '?'}}
                                        </div>
                                        <div>
                                            <h6 class="fw-bold mb-0">{{booking.touristName}}</h6>
                                            <div class="text-muted small">Booked on {{booking.bookingDate |
                                                date:'mediumDate'}}</div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold">{{booking.numberOfPeople}} Seats</div>
                                        <div class="small text-muted">{{booking.totalAmount | number}} PKR</div>
                                    </div>
                                    <div>
                                        <span class="badge" [class.bg-success]="booking.status === 'Confirmed'"
                                            [class.bg-warning]="booking.status === 'Pending'"
                                            [class.bg-danger]="booking.status === 'Cancelled'">
                                            {{booking.status}}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

            <!-- Placeholder for no selection -->
            <ng-template #noSelection>
                <div class="card border-0 shadow-sm rounded-4 d-flex align-items-center justify-content-center bg-white"
                    style="min-height: 600px;">
                    <div class="text-center p-5">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-4"
                            style="width: 100px; height: 100px;">
                            <i class="bi bi-cursor-fill fs-1 text-primary-emphasis opacity-25"></i>
                        </div>
                        <h4 class="fw-bold text-dark mb-2">Select a Tour</h4>
                        <p class="text-muted mx-auto" style="max-width: 300px;">
                            Choose a tour from the left list to view its full details, requirements, and bookings.
                        </p>
                    </div>
                </div>
            </ng-template>
        </div>

    </div>


    <!-- Custom Confirmation Modal -->
    <app-confirmation-modal [isVisible]="showConfirmModal" [title]="confirmTitle" [message]="confirmMessage"
        [confirmText]="confirmText" [cancelText]="cancelText" [type]="confirmType" (onConfirm)="onConfirmAction()"
        (onCancel)="onCancelAction()">
    </app-confirmation-modal>
</div>